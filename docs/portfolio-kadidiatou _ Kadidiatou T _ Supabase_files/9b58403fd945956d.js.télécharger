;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="8f7182c6-8204-2579-cff9-ebbeb24dd0da")}catch(e){}}();
(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,821463,e=>{"use strict";var t=e.i(478902),r=e.i(645974);e.i(128328);var s=e.i(158639),a=e.i(888525);let i=()=>{let[{sort:e,order:t},s]=(0,r.useQueryStates)({sort:r.parseAsString,order:r.parseAsString});return{sort:e&&t&&["asc","desc"].includes(t)?{column:e,order:t}:null,setSortConfig:(e,t)=>{s({sort:e,order:t})},clearSort:()=>{s({sort:null,order:null})}}};var l=e.i(389959),n=e.i(177948),o=e.i(710377),c=e.i(749844),d=e.i(88816),u=e.i(602158),m=e.i(591385),p=e.i(215312),x=e.i(837710),h=e.i(672044),f=e.i(874311),g=e.i(725137),_=e.i(283606),y=e.i(314805),b=e.i(408279),j=e.i(500850),v=e.i(843778),w=e.i(252387),N=e.i(108151),S=e.i(710483),C=e.i(760255),T=e.i(774803),R=e.i(635494),A=e.i(71049),q=e.i(479095),E=e.i(877555),F=e.i(593977),k=e.i(770235),P=e.i(908942);let L=({indexAdvisorResult:e,onClickIcon:r})=>{let{data:s}=(0,R.useSelectedProjectQuery)(),[a,i]=(0,l.useState)(!1),[n,o]=(0,l.useState)(!1),c=(0,P.useIndexInvalidation)(),d=async t=>{t.stopPropagation(),i(!0);try{await (0,C.createIndexes)({projectRef:s?.ref,connectionString:s?.connectionString,indexStatements:e.index_statements,onSuccess:()=>{r&&(r(),o(!1))}}),c()}catch(e){console.error("Failed to create index:",e),i(!1)}finally{setTimeout(()=>i(!1),1e3)}};return e?.index_statements?.length?(0,t.jsxs)(A.HoverCard,{open:n,onOpenChange:o,children:[(0,t.jsx)(A.HoverCardTrigger,{children:(0,t.jsx)("div",{onClick:e=>{r&&!a&&(e.stopPropagation(),r())},className:"cursor-pointer",children:a?(0,t.jsx)(T.Loader2,{size:16,className:"animate-spin text-foreground-light"}):(0,t.jsx)(E.WarningIcon,{})})}),(0,t.jsxs)(A.HoverCardContent,{className:"w-[520px] p-0 overflow-hidden",align:"start",alignOffset:-32,children:[(0,t.jsx)("div",{className:"px-4 py-3 bg-surface-75",children:(0,t.jsx)(F.IndexImprovementText,{indexStatements:e.index_statements,totalCostBefore:e.total_cost_before,totalCostAfter:e.total_cost_after,className:"text-sm"})}),(0,t.jsx)(q.Separator,{}),(0,t.jsx)("div",{children:(0,t.jsx)(h.CodeBlock,{hideLineNumbers:!0,value:e.index_statements.join(";\n")+";",language:"sql",className:(0,v.cn)("border-none rounded-none","max-w-full","!py-0.5 !px-3.5 prose dark:prose-dark transition","[&>code]:m-0 [&>code>span]:flex [&>code>span]:flex-wrap")})}),(0,t.jsx)(q.Separator,{}),(0,t.jsx)(k.QueryPanelScoreSection,{name:"Total cost of query",description:"An estimate of how long it will take to return all the rows (Includes start up cost)",before:e.total_cost_before,after:e.total_cost_after}),(0,t.jsx)(k.QueryPanelScoreSection,{hideArrowMarkers:!0,className:"border-t",name:"Start up cost",description:"An estimate of how long it will take to fetch the first row",before:e.startup_cost_before,after:e.startup_cost_after}),(0,t.jsxs)("div",{className:"p-3 flex gap-2 items-center border-t justify-end",children:[(0,t.jsx)(x.Button,{type:"text",onClick:e=>{e.stopPropagation(),r&&!a&&r(),o(!1)},disabled:a,children:"View details"}),(0,t.jsx)(x.Button,{onClick:d,loading:a,disabled:a,children:"Create index"})]})]})]}):null};var I=e.i(657588),D=e.i(215618),M=e.i(867987),Q=e.i(887093),$=e.i(967052),O=e.i(365257),B=e.i(924115),z=e.i(308777),H=e.i(317040),U=e.i(441081);function V(e){let t=`Total Time: ${e.total_time.toLocaleString()}
Calls: ${e.calls.toLocaleString()}
Mean Time: ${e.mean_time.toLocaleString()}
Max Time: ${e.max_time.toLocaleString()}
Min Time: ${e.min_time.toLocaleString()}
Rows Read: ${e.rows_read.toLocaleString()}
Cache Hit Rate: ${e.cache_hit_rate.toLocaleString()}%
Role: ${e.rolname}`,r="";if(e.index_advisor_result){let t=e.index_advisor_result;t.index_statements.length>0&&(r=`

Index Advisor Recommendations:
${t.index_statements.join("\n")}

Cost Analysis:
- Startup Cost Before: ${t.startup_cost_before}
- Startup Cost After: ${t.startup_cost_after}
- Total Cost Before: ${t.total_cost_before}
- Total Cost After: ${t.total_cost_after}`)}let s=`Analyze this database query and provide a brief, concise explanation:

**Performance Metrics:**
${t}

${r}

Provide a short response covering:
1. What the query does (1-2 sentences)
2. Performance assessment (good/concerning and why, keep it brief 2-3 sentences)
3. Actionable optimization suggestions (if any, keep it brief 2-3 sentences)

Keep your response concise and focused on actionable insights. We can continue the conversation if needed to get more details.`;return{query:e.query,prompt:s}}e.i(178527),e.i(206413),e.i(592360);var W=e.i(764275),Y=e.i(469449),G=e.i(817729),K=e.i(55956),X=e.i(114106);function J(e){return null==e?null:"string"==typeof e?e:e instanceof Error?e.message:"object"==typeof e&&null!==e&&"message"in e?String(e.message):String(e)}K.default.extend(X.default);let Z=e=>{let t=K.default.duration(e,"milliseconds"),r=Math.floor(t.asDays()),s=t.hours(),a=t.minutes(),i=t.seconds(),l=t.asSeconds();if(l<60)return`${l.toFixed(2)}s`;let n=[];return r>0&&n.push(`${r}d`),s>0&&n.push(`${s}h`),a>0&&n.push(`${a}m`),i>0&&n.push(`${i}s`),n.length>0?n.join(" "):"0s"};function ee(e,t){Y.withScope(r=>{if(r.setTag("query-performance","true"),r.setContext("query-performance",{projectRef:t.projectRef,databaseIdentifier:t.databaseIdentifier,queryPreset:t.queryPreset,queryType:t.queryType,postgresVersion:t.postgresVersion,databaseType:t.databaseType,errorMessage:t.errorMessage}),e instanceof Error)return void G.captureException(e);let s=Error(J(e)||"Query performance error");null!=e&&(s.cause=e),G.captureException(s)})}let et=(0,z.default)(()=>e.A(444600).then(({SqlMonacoBlock:e})=>e),{loadableGenerated:{modules:[89570]},ssr:!1}),er=({selectedRow:e,onClickViewSuggestion:r,onClose:s})=>{let a=W.QUERY_PERFORMANCE_COLUMNS,[i,n]=(0,l.useState)(e?.query),{openSidebar:o}=(0,U.useSidebarManagerSnapshot)(),c=(0,H.useAiAssistantStateSnapshot)(),d=(0,$.useTrack)(),u=(0,I.useFlag)("ShowExplainWithAiInQueryPerformance");(0,l.useEffect)(()=>{void 0!==e&&n((0,Q.formatSql)(e.query))},[e]);let[m,p]=(0,l.useState)(!1);return(0,t.jsxs)(k.QueryPanelContainer,{children:[(0,t.jsxs)(k.QueryPanelSection,{className:"pt-2 border-b relative",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,t.jsx)("h4",{children:"Query pattern"}),u&&(0,t.jsx)(M.AiAssistantDropdown,{label:"Explain with AI",buildPrompt:()=>{if(!e?.query)return"";let{query:t,prompt:r}=V(e);return`${r}

SQL Query:
\`\`\`sql
${t}
\`\`\``},onOpenAssistant:()=>{if(!e?.query)return;let{query:t,prompt:r}=V(e);o(D.SIDEBAR_KEYS.AI_ASSISTANT),c.newChat({sqlSnippets:[{label:"Query",content:t}],initialMessage:r}),d("query_performance_explain_with_ai_button_clicked"),s?.()},telemetrySource:"query_performance",size:"tiny",type:"default"})]}),(0,t.jsxs)("div",{className:(0,v.cn)("overflow-hidden pb-0 z-0 relative transition-all duration-300",m?"h-[348px]":"h-[120px]"),children:[(0,t.jsx)(et,{value:i,height:322,lineNumbers:"off",wrapperClassName:(0,v.cn)("pl-3 bg-surface-100",!m&&"pointer-events-none")}),!1]}),(0,t.jsx)("div",{className:(0,v.cn)("absolute left-0 bottom-0 w-full bg-gradient-to-t from-black/30 to-transparent h-24 transition-opacity duration-300",m&&"opacity-0 pointer-events-none")}),(0,t.jsx)("div",{className:"absolute -bottom-[13px] left-0 right-0 w-full flex items-center justify-center z-10",children:(0,t.jsx)(x.Button,{type:"default",className:"rounded-full",icon:(0,t.jsx)(O.ChevronsUpDown,{}),onClick:()=>p(!m),children:m?"Collapse":"Expand"})})]}),(0,t.jsxs)(k.QueryPanelSection,{className:"pb-3 pt-6",children:[(0,t.jsx)("h4",{className:"mb-2",children:"Metadata"}),(0,t.jsx)("ul",{className:"flex flex-col gap-y-3 divide-y divide-dashed",children:a.filter(e=>"query"!==e.id).map(r=>{let s=e?.[r.id],a=r.name.includes("time")?"number"==typeof s&&!isNaN(s)&&isFinite(s)?`${Math.round(s).toLocaleString()}ms`:"n/a":null!=s?String(s):"n/a";if("prop_total_time"===r.id){let s=e?.prop_total_time||0,a=e?.total_time||0;return(0,t.jsxs)("li",{className:"flex justify-between pt-3 text-sm",children:[(0,t.jsx)("p",{className:"text-foreground-light",children:r.name}),s&&a?(0,t.jsxs)("p",{className:"flex items-center gap-x-1.5",children:[(0,t.jsxs)("span",{className:(0,v.cn)("tabular-nums","0.0"===s.toFixed(1)&&"text-foreground-lighter"),children:[s.toFixed(1),"%"]})," ",(0,t.jsx)("span",{className:"text-muted",children:"/"})," ",(0,t.jsx)("span",{className:(0,v.cn)("tabular-nums","0.00s"===Z(a)&&"text-foreground-lighter"),children:Z(a)})]}):(0,t.jsx)("p",{className:"text-muted",children:"–"})]},r.id)}if("rows_read"==r.id)return(0,t.jsxs)("li",{className:"flex justify-between pt-3 text-sm",children:[(0,t.jsx)("p",{className:"text-foreground-light",children:r.name}),"number"==typeof s&&!isNaN(s)&&isFinite(s)?(0,t.jsx)("p",{className:(0,v.cn)("tabular-nums",0===s&&"text-foreground-lighter"),children:s.toLocaleString()}):(0,t.jsx)("p",{className:"text-muted",children:"–"})]},r.id);let i=e=>"number"==typeof e?e:parseFloat(e.toString().replace("%",""))||0;return"cache_hit_rate"===r.id?(0,t.jsxs)("li",{className:"flex justify-between pt-3 text-sm",children:[(0,t.jsx)("p",{className:"text-foreground-light",children:r.name}),"string"==typeof s||"number"==typeof s?(0,t.jsxs)("p",{className:(0,v.cn)("0.00"===i(s).toFixed(2)&&"text-foreground-lighter"),children:[i(s).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),"%"]}):(0,t.jsx)("p",{className:"text-muted",children:"–"})]},r.id):(0,t.jsxs)("li",{className:"flex justify-between pt-3 text-sm",children:[(0,t.jsx)("p",{className:"text-foreground-light",children:r.name}),(0,t.jsx)("p",{className:(0,v.cn)("tabular-nums","rolname"===r.id&&"font-mono"),children:a})]},r.id)})})]})]})};var es=e.i(331906);let ea=({aggregatedData:e,isLoading:a,error:T,currentSelectedQuery:R,onCurrentSelectQuery:A,onRetry:q})=>{let{sort:E,setSortConfig:F}=i(),k=(0,l.useRef)(null),{sort:P,order:I}=(0,s.useParams)(),[{search:D,roles:M,callsFilter:Q}]=(0,r.useQueryStates)({search:r.parseAsString.withDefault(""),roles:(0,r.parseAsArrayOf)(r.parseAsString).withDefault([]),callsFilter:(0,r.parseAsJson)(e=>e).withDefault({operator:">=",value:0})}),$=(0,l.useRef)(null),[O,B]=(0,l.useState)("details"),[z,H]=(0,l.useState)();W.QUERY_PERFORMANCE_REPORT_TYPES.UNIFIED;let U=W.QUERY_PERFORMANCE_COLUMNS.map(r=>{let s=["query"];return{key:r.id,name:r.name,cellClass:`column-${r.id}`,resizable:!0,minWidth:"prop_total_time"===r.id?(e=>{if(!e||0===e.length)return 150;let t=150;return e.forEach(e=>{let r=e.prop_total_time||0,s=e.total_time||0;if(r&&s){let e=`${r.toFixed(1)}%`,a=Z(s),i=8*`${e} / ${a}`.length+40;t=Math.max(t,i)}}),Math.min(t,300)})(e??[]):r.minWidth??120,sortable:!s.includes(r.id),headerCellClass:"first:pl-6 cursor-pointer",renderHeaderCell:()=>{let e=!s.includes(r.id);return(0,t.jsxs)("div",{className:"flex items-center justify-between text-xs w-full",children:[(0,t.jsxs)("div",{className:"flex items-center gap-x-2",children:[(0,t.jsx)("p",{className:"!text-foreground font-medium",children:r.name}),r.description&&(0,t.jsx)("p",{className:"text-foreground-lighter font-normal",children:r.description})]}),e&&(0,t.jsxs)(f.DropdownMenu,{children:[(0,t.jsx)(f.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsx)(x.Button,{type:"text",size:"tiny",className:"p-1 h-5 w-5 flex-shrink-0",icon:(0,t.jsx)(d.ChevronDown,{size:14,className:"text-foreground-muted"}),onClick:e=>e.stopPropagation()})}),(0,t.jsxs)(f.DropdownMenuContent,{align:"end",className:"w-48",children:[(0,t.jsxs)(f.DropdownMenuItem,{onClick:()=>{F(r.id,"asc")},className:(0,v.cn)("flex gap-2",E?.column===r.id&&E?.order==="asc"&&"text-foreground"),children:[(0,t.jsx)(c.ArrowUp,{size:14}),"Sort Ascending"]}),(0,t.jsxs)(f.DropdownMenuItem,{onClick:()=>{F(r.id,"desc")},className:(0,v.cn)("flex gap-2",E?.column===r.id&&E?.order==="desc"&&"text-foreground"),children:[(0,t.jsx)(n.ArrowDown,{size:14}),"Sort Descending"]})]})]})]})},renderCell:e=>{let s=e.row?.[r.id];if("query"===r.id)return(0,t.jsxs)("div",{className:"w-full flex items-center gap-x-3 group",children:[(0,t.jsx)("div",{className:"flex-shrink-0 w-4",children:(0,C.hasIndexRecommendations)(e.row.index_advisor_result,!0)&&(0,t.jsx)(L,{indexAdvisorResult:e.row.index_advisor_result,onClickIcon:()=>{H(e.rowIdx),B("suggestion"),k.current?.scrollToCell({idx:0,rowIdx:e.rowIdx})}})}),(0,t.jsx)(h.CodeBlock,{language:"pgsql",className:"!bg-transparent !p-0 !m-0 !border-none !whitespace-nowrap [&>code]:!whitespace-nowrap [&>code]:break-words !overflow-visible !truncate !w-full !pr-20 pointer-events-none",wrapperClassName:"!max-w-full flex-1",hideLineNumbers:!0,hideCopy:!0,value:s.replace(/\s+/g," ").trim(),wrapLines:!1}),A&&(0,t.jsx)(p.ButtonTooltip,{tooltip:{content:{text:"Query details"}},icon:(0,t.jsx)(o.ArrowRight,{size:14}),size:"tiny",type:"default",onClick:t=>{t.stopPropagation(),H(e.rowIdx),B("details"),k.current?.scrollToCell({idx:0,rowIdx:e.rowIdx})},className:"p-1 flex-shrink-0 -translate-x-2 group-hover:flex hidden"})]});let a=r.name.includes("time"),i=s&&"number"==typeof s&&!isNaN(s)&&isFinite(s)?a?`${s.toFixed(0).toLocaleString()}ms`:s.toLocaleString():"";if("prop_total_time"===r.id){let r=e.row.prop_total_time||0,s=e.row.total_time||0,a=Math.min(r,100);return(0,t.jsxs)("div",{className:"w-full flex flex-col justify-center text-xs text-right tabular-nums font-mono",children:[(0,t.jsx)("div",{className:"absolute inset-0 bg-foreground transition-all duration-200 z-0",style:{width:`${a}%`,opacity:.04}}),r&&s?(0,t.jsxs)("span",{className:"flex items-center justify-end gap-x-1.5",children:[(0,t.jsxs)("span",{className:(0,v.cn)("0.0"===r.toFixed(1)&&"text-foreground-lighter"),children:[r.toFixed(1),"%"]})," ",(0,t.jsx)("span",{className:"text-muted",children:"/"}),(0,t.jsx)("span",{className:(0,v.cn)("0.00s"===Z(s)&&"text-foreground-lighter"),children:Z(s)})]}):(0,t.jsx)("p",{className:"text-muted",children:"–"})]})}if("calls"===r.id)return(0,t.jsx)("div",{className:"w-full flex flex-col justify-center text-xs text-right tabular-nums font-mono",children:"number"==typeof s&&!isNaN(s)&&isFinite(s)?(0,t.jsx)("p",{className:(0,v.cn)(0===s&&"text-foreground-lighter"),children:s.toLocaleString()}):(0,t.jsx)("p",{className:"text-muted",children:"–"})});if("max_time"===r.id||"mean_time"===r.id||"min_time"===r.id)return(0,t.jsx)("div",{className:"w-full flex flex-col justify-center text-xs text-right tabular-nums font-mono",children:"number"==typeof s&&!isNaN(s)&&isFinite(s)?(0,t.jsxs)("p",{className:(0,v.cn)("0"===s.toFixed(0)&&"text-foreground-lighter"),children:[Math.round(s).toLocaleString(),"ms"]}):(0,t.jsx)("p",{className:"text-muted",children:"–"})});if("rows_read"===r.id)return(0,t.jsx)("div",{className:"w-full flex flex-col justify-center text-xs text-right tabular-nums font-mono",children:"number"==typeof s&&!isNaN(s)&&isFinite(s)?(0,t.jsx)("p",{className:(0,v.cn)(0===s&&"text-foreground-lighter"),children:s.toLocaleString()}):(0,t.jsx)("p",{className:"text-muted",children:"–"})});if("cache_hit_rate"===r.id){let e="number"==typeof s?s:parseFloat(s);return(0,t.jsx)("div",{className:"w-full flex flex-col justify-center text-xs text-right tabular-nums font-mono",children:"number"==typeof e&&!isNaN(e)&&isFinite(e)?(0,t.jsxs)("p",{className:(0,v.cn)("0.00"===e.toFixed(2)&&"text-foreground-lighter"),children:[e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}),"%"]}):(0,t.jsx)("p",{className:"text-muted",children:"–"})})}return"rolname"===r.id?(0,t.jsx)("div",{className:"w-full flex flex-col justify-center",children:s?(0,t.jsxs)("span",{className:"flex items-center gap-x-1",children:[(0,t.jsx)("p",{className:"font-mono text-xs",children:s}),(0,t.jsx)(w.InfoTooltip,{align:"end",alignOffset:-12,className:"w-56",children:W.QUERY_PERFORMANCE_ROLE_DESCRIPTION.find(e=>e.name===s)?.description})]}):(0,t.jsx)("p",{className:"text-muted",children:"–"})}):(0,t.jsx)("div",{className:"w-full flex flex-col gap-y-0.5 justify-center text-xs",children:(0,t.jsx)("p",{children:i})})}}}),V=(0,l.useMemo)(()=>{let t=[...e];if(D&&"string"==typeof D&&D.length>0&&(t=t.filter(e=>e.query.toLowerCase().includes(D.toLowerCase()))),M&&Array.isArray(M)&&M.length>0&&(t=t.filter(e=>e.rolname&&M.includes(e.rolname))),Q){let{operator:e,value:r}=Q;t=t.filter(t=>{let s=t.calls||0;switch(e){case"=":return s===r;case">=":return s>=r;case"<=":return s<=r;case">":return s>r;case"<":return s<r;case"!=":return s!==r;default:return!0}})}return E?.column==="prop_total_time"?t.sort((e,t)=>{let r=e.prop_total_time||0,s=t.prop_total_time||0;return"asc"===E.order?r-s:s-r}):E?.column&&"query"!==E.column&&t.sort((e,t)=>{let r=e[E.column]||0,s=t[E.column]||0;return"number"==typeof r&&"number"==typeof s?"asc"===E.order?r-s:s-r:0}),t},[e,E,D,M,Q]);(0,l.useEffect)(()=>{H(void 0)},[D,M,P,I,Q]);let Y=(0,l.useCallback)(e=>{if(!V.length||void 0===z||"ArrowUp"!==e.key&&"ArrowDown"!==e.key)return;e.stopPropagation();let t=z;"ArrowUp"===e.key&&z>0?t=z-1:"ArrowDown"===e.key&&z<V.length-1&&(t=z+1),t!==z&&(H(t),k.current?.scrollToCell({idx:0,rowIdx:t}),(V[t]?.query??"").trim().toLowerCase().startsWith("select")||B("details"))},[V,z]);(0,l.useEffect)(()=>(window.addEventListener("keydown",Y,!0),()=>{window.removeEventListener("keydown",Y,!0)}),[Y]);let G=e=>{if(!e)return!1;let t=e.trim().toLowerCase();return t.startsWith("select")||t.startsWith("with pgrst_source")||t.startsWith("with pgrst_payload")};if((0,l.useEffect)(()=>{void 0!==z&&"suggestion"===O&&(G(V[z]?.query)||B("details"))},[z,O,V]),T)return(0,t.jsx)("div",{className:"relative flex flex-grow bg-alternative min-h-0",children:(0,t.jsx)("div",{className:"flex-1 min-w-0 p-6",children:(0,t.jsx)(S.Admonition,{type:"destructive",title:"Failed to load query performance data",description:T,children:q&&(0,t.jsx)("div",{className:"mt-4",children:(0,t.jsx)(x.Button,{type:"default",onClick:q,children:"Try again"})})})})});let K=void 0!==z?V[z]?.query:void 0,X=(0,C.queryInvolvesProtectedSchemas)(K),J=G(K)&&!X;return(0,t.jsxs)("div",{className:"relative flex flex-grow bg-alternative min-h-0",children:[(0,t.jsx)("div",{ref:$,className:"flex-1 min-w-0 overflow-x-auto",children:(0,t.jsx)(m.default,{ref:k,style:{height:"100%"},className:(0,v.cn)("flex-1 flex-grow h-full"),rowHeight:44,headerRowHeight:36,columns:U,rows:V,rowClass:(e,t)=>{let r=t===z,s=V[t]?.query,a=!!R&&R===s,i=(0,C.hasIndexRecommendations)(V[t]?.index_advisor_result,!0);return`${r?i?"bg-warning/10 hover:bg-warning/20":"bg-surface-300 dark:bg-surface-300":i?"bg-warning/10 hover:bg-warning/20":"bg-200 hover:bg-surface-200"} cursor-pointer ${r?i?"[&>div:first-child]:border-l-4 border-l-warning [&>div]:border-l-warning":"[&>div:first-child]:border-l-4 border-l-secondary [&>div]:!border-l-foreground":""} ${a?"bg-surface-200 dark:bg-surface-200":""} ${a?"[&>div:first-child]:border-l-4 border-l-secondary [&>div]:border-l-brand":""} [&>.rdg-cell]:box-border [&>.rdg-cell]:outline-none [&>.rdg-cell]:shadow-none [&>.rdg-cell.column-prop_total_time]:relative`},renderers:{renderRow:(e,t)=>(0,l.createElement)(m.Row,{...t,key:`qp-row-${t.rowIdx}`,onClick:t=>{if(t.stopPropagation(),"number"==typeof e&&e>=0)if(A){let t=V[e]?.query;t&&A(t)}else H(e),B((0,C.hasIndexRecommendations)(V[e]?.index_advisor_result,!0)?"suggestion":"details"),k.current?.scrollToCell({idx:0,rowIdx:e})}}),noRowsFallback:a?(0,t.jsx)("div",{className:"absolute top-14 px-6 w-full",children:(0,t.jsx)(N.GenericSkeletonLoader,{})}):(0,t.jsxs)("div",{className:"absolute top-20 px-6 flex flex-col items-center justify-center w-full gap-y-2",children:[(0,t.jsx)(u.TextSearch,{className:"text-foreground-muted",strokeWidth:1}),(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("p",{className:"text-foreground",children:"No queries detected"}),(0,t.jsx)("p",{className:"text-foreground-light",children:"There are no actively running queries that match the criteria"})]})]})}})}),(0,t.jsxs)(g.Sheet,{open:void 0!==z,onOpenChange:e=>{e||H(void 0)},modal:!1,children:[(0,t.jsx)(g.SheetTitle,{className:"sr-only",children:"Query details"}),(0,t.jsx)(g.SheetDescription,{className:"sr-only",children:"Query Performance Details & Indexes"}),(0,t.jsx)(g.SheetContent,{side:"right",className:"flex flex-col h-full bg-studio border-l lg:!w-[calc(100vw-802px)] max-w-[700px] w-full",hasOverlay:!1,onInteractOutside:e=>{$.current?.contains(e.target)&&e.preventDefault()},children:(0,t.jsxs)(j.Tabs_Shadcn_,{value:O,className:"flex flex-col h-full",onValueChange:e=>B(e),children:[(0,t.jsx)("div",{className:"px-5 border-b",children:(0,t.jsxs)(y.TabsList_Shadcn_,{className:"px-0 flex gap-x-4 min-h-[46px] border-b-0 [&>button]:h-[47px]",children:[(0,t.jsx)(b.TabsTrigger_Shadcn_,{value:"details",className:"px-0 pb-0 data-[state=active]:bg-transparent !shadow-none",children:"Query details"}),void 0!==z&&J&&(0,t.jsx)(b.TabsTrigger_Shadcn_,{value:"suggestion",className:"px-0 pb-0 data-[state=active]:bg-transparent !shadow-none",children:"Indexes"})]})}),(0,t.jsx)(_.TabsContent_Shadcn_,{value:"details",className:"mt-0 flex-grow min-h-0 overflow-y-auto",children:void 0!==z&&(0,t.jsx)(er,{selectedRow:V[z],onClickViewSuggestion:()=>B("suggestion"),onClose:()=>H(void 0)})}),void 0!==z&&J&&(0,t.jsx)(_.TabsContent_Shadcn_,{value:"suggestion",className:"mt-0 flex-grow min-h-0 overflow-y-auto",children:(0,t.jsx)(es.QueryIndexes,{selectedRow:V[z]})})]})})]})]})};var ei=e.i(248210),el=e.i(883599),en=e.i(421781);K.default.extend(en.default);let eo=e=>{let t=[{min:0,max:1},{min:1,max:10},{min:10,max:100},{min:100,max:1e3},{min:1e3,max:1e4},{min:1e4,max:1e5}],r=e.reduce((e,t)=>e+t,0);if(0===r)return{p50:0,p95:0};let s=[],a=0;e.forEach((e,r)=>{if(e>0&&r<t.length){let i=t[r];a+=e,s.push({minValue:i.min,maxValue:i.max,cumulativeCount:a,count:e})}});let i=e=>{let t=r*e;for(let e=0;e<s.length;e++){let r=e>0?s[e-1].cumulativeCount:0;if(s[e].cumulativeCount>=t){let a=(t-r)/s[e].count,i=s[e].minValue,l=s[e].maxValue,n=Math.log10(Math.max(i,.1));return Math.pow(10,n+a*(Math.log10(l)-n))}}return s[s.length-1]?.maxValue||0};return{p50:i(.5),p95:i(.95)}},ec=({label:e,value:r})=>(0,t.jsxs)("div",{className:"flex flex-col gap-0.5 text-xs",children:[(0,t.jsx)("span",{className:"font-mono text-xs text-foreground-lighter uppercase",children:e}),(0,t.jsx)("span",{className:"text-lg tabular-nums",children:r})]}),ed=e=>e>=1e3?`${(e/1e3).toFixed(1)}s`:`${e.toFixed(1)}ms`,eu=e=>e.toLocaleString(),em=({onDateRangeChange:e,chartData:r,isLoading:s,error:a,currentSelectedQuery:i,parsedLogs:n})=>{let[o,c]=(0,l.useState)("query_latency"),d=(0,l.useMemo)(()=>{if(!r||0===r.length)return[];switch(o){case"query_latency":{let e=0;if(n&&n.length>0){let t=Array(n[0]?.resp_calls?.length||50).fill(0);n.forEach(e=>{e.resp_calls&&Array.isArray(e.resp_calls)&&e.resp_calls.forEach((e,r)=>{r<t.length&&(t[r]+=e)})}),e=eo(t).p95}else{let t=r.reduce((e,t)=>e+t.calls,0);e=t>0?r.reduce((e,t)=>e+t.p95_time*t.calls,0)/t:0}return[{label:"Average p95",value:`${Math.round(e)}ms`}]}case"rows_read":return[{label:"Total Rows Read",value:r.reduce((e,t)=>e+t.rows_read,0).toLocaleString()}];case"calls":return[{label:"Total Calls",value:r.reduce((e,t)=>e+t.calls,0).toLocaleString()}];case"cache_hits":{let e=r.reduce((e,t)=>e+t.cache_hits,0),t=e+r.reduce((e,t)=>e+t.cache_misses,0);return[{label:"Cache Hit Rate",value:`${(t>0?e/t*100:0).toFixed(2)}%`}]}default:return[]}},[r,o]),u=(0,l.useMemo)(()=>"query_latency"!==o?r:r.map(e=>({...e,p50_time:parseFloat((e.p50_time/1e3).toFixed(3)),p95_time:parseFloat((e.p95_time/1e3).toFixed(3))})),[r,o]),m=(0,l.useMemo)(()=>{if(!i||!n.length)return null;let e=i.replace(/\s+/g," ").trim(),t=n.filter(t=>(t.query||"").replace(/\s+/g," ").trim()===e),r=new Map;return t.forEach(e=>{let t=[e.bucket_start_time,e.bucket,e.timestamp,e.ts].find(e=>e&&!isNaN(new Date(e).getTime()));if(!t)return;let s=new Date(t).getTime(),a=e.mean_time??e.mean_exec_time??e.mean_query_time??0,i=e.rows_read??e.rows??0,l=e.calls??0,n=e.shared_blks_hit??e.cache_hits??0;r.set(s,{time:parseFloat(String(a)),rows_read:parseFloat(String(i)),calls:parseFloat(String(l)),cache_hits:parseFloat(String(n))})}),r},[i,n]),p=(0,l.useMemo)(()=>m&&i?u.map(e=>{let t=m.get(e.period_start);return{...e,selected_query_time:t?.time!==void 0?"query_latency"===o?t.time/1e3:t.time:null,selected_query_rows_read:t?.rows_read!==void 0?t.rows_read:null,selected_query_calls:t?.calls!==void 0?t.calls:null,selected_query_cache_hits:t?.cache_hits!==void 0?t.cache_hits:null}}):u,[u,m,i,o]),x=(0,l.useMemo)(()=>{let e={query_latency:[{attribute:"p50_time",label:"p50",provider:"logs",type:"line",color:{light:"#8B5CF6",dark:"#8B5CF6"}},{attribute:"p95_time",label:"p95",provider:"logs",type:"line",color:{light:"#65BCD9",dark:"#65BCD9"}}],rows_read:[{attribute:"rows_read",label:"Rows Read",provider:"logs"}],calls:[{attribute:"calls",label:"Calls",provider:"logs"}],cache_hits:[{attribute:"cache_hits",label:"Cache Hits",provider:"logs",type:"line",color:{light:"#10B981",dark:"#10B981"}}]}[o]||[];if(i&&m){let t={query_latency:{attribute:"selected_query_time",label:"Selected Query",provider:"logs",type:"line",color:{light:"#10B981",dark:"#10B981"},strokeWidth:3},rows_read:{attribute:"selected_query_rows_read",label:"Selected Query",provider:"logs",type:"line",color:{light:"#F59E0B",dark:"#F59E0B"},strokeWidth:3},calls:{attribute:"selected_query_calls",label:"Selected Query",provider:"logs",type:"line",color:{light:"#EC4899",dark:"#EC4899"},strokeWidth:3},cache_hits:{attribute:"selected_query_cache_hits",label:"Selected Query",provider:"logs",type:"line",color:{light:"#8B5CF6",dark:"#8B5CF6"},strokeWidth:3}}[o];if(t)return[...e,t]}return e},[o,i,m]),h=(0,l.useMemo)(()=>"query_latency"===o?ed:eu,[o]);return(0,t.jsx)("div",{className:"bg-surface-200 border-t",children:(0,t.jsxs)(j.Tabs_Shadcn_,{value:o,onValueChange:e=>c(e),className:"w-full",children:[(0,t.jsx)(y.TabsList_Shadcn_,{className:"flex justify-start rounded-none gap-x-4 border-b !mt-0 pt-0 px-6",children:W.QUERY_PERFORMANCE_CHART_TABS.map(e=>(0,t.jsx)(b.TabsTrigger_Shadcn_,{value:e.id,className:"flex items-center gap-2 text-xs py-3 border-b-[1px] font-mono uppercase",children:e.label},e.id))}),(0,t.jsx)(_.TabsContent_Shadcn_,{value:o,className:"bg-surface-200 mt-0 h-inherit",children:(0,t.jsx)("div",{className:"w-full flex items-center justify-center min-h-[282px]",children:s?(0,t.jsx)(T.Loader2,{size:20,className:"animate-spin text-foreground-lighter"}):a?(0,t.jsx)("p",{className:"text-sm text-foreground-light text-center h-full flex items-center justify-center",children:"Error loading chart data"}):(0,t.jsxs)("div",{className:"w-full flex flex-col h-full px-6 py-4",children:[(0,t.jsx)("div",{className:"flex gap-6 mb-4",children:d.map((e,r)=>(0,t.jsx)(ec,{label:e.label,value:e.value},r))}),(0,t.jsx)(el.ComposedChart,{data:p,attributes:x,yAxisKey:x[0]?.attribute||"",xAxisKey:"period_start",title:"",customDateFormat:"MMM D, YYYY hh:mm A",hideChartType:!0,hideHighlightArea:!0,showTooltip:!0,showGrid:!0,showLegend:"query_latency"===o||"cache_hits"===o||"rows_read"===o||"calls"===o,showTotal:!1,showMaxValue:!1,updateDateRange:(t,r)=>{e?.(t,r)},YAxisProps:{tick:!0,width:60,tickFormatter:h},xAxisIsDate:!0,className:"mt-2"})]})})})]})})};var ep=e.i(932291),ex=e.i(366652),eh=e.i(975924),ef=e.i(746301);let eg=({value:e,onChange:r,placeholder:s,className:a})=>(0,t.jsx)(ef.Input,{size:"tiny",autoComplete:"off",icon:(0,t.jsx)(ex.Search,{}),value:e,onChange:e=>r(e.target.value),name:"keyword",id:"keyword",placeholder:s||"Filter by query",className:a||"w-56",actions:[e&&(0,t.jsx)(x.Button,{size:"tiny",type:"text",icon:(0,t.jsx)(eh.X,{}),onClick:()=>r(""),className:"p-0 h-5 w-5"})]});var e_=e.i(613580);let ey=({label:e,value:r,onClear:s})=>(0,t.jsxs)("div",{className:"text-xs border rounded-md px-1.5 md:px-2.5 py-1 h-[26px] flex items-center gap-x-2",children:[(0,t.jsxs)("p",{className:"md:inline-flex gap-x-1 hidden truncate",children:[e,": ",(0,t.jsx)("span",{className:"text-foreground-lighter",children:r})]}),(0,t.jsxs)(e_.Tooltip,{children:[(0,t.jsx)(e_.TooltipTrigger,{onClick:e=>{e.stopPropagation(),s(e)},children:(0,t.jsx)(eh.X,{size:14,className:"text-foreground-light hover:text-foreground"})}),(0,t.jsxs)(e_.TooltipContent,{side:"bottom",children:["Clear ",e.toLowerCase()," filter"]})]})]}),eb=({isActive:e,onToggle:r})=>(0,t.jsx)(x.Button,{type:e?"default":"outline",size:"tiny",className:(0,v.cn)(e?"bg-surface-300":"border-dashed"),onClick:r,iconRight:e?(0,t.jsx)(eh.X,{size:14}):void 0,children:(0,t.jsxs)("span",{className:"flex items-center gap-x-2",children:[(0,t.jsx)(B.Lightbulb,{size:12,className:e?"text-warning":"text-foreground-lighter"}),(0,t.jsx)("span",{children:"Index Advisor"})]})});var ej=e.i(830495);let ev=({htmlFor:e,label:r,description:s,className:a})=>{let i=(0,t.jsx)("label",{htmlFor:e,className:(0,v.cn)("flex items-center gap-x-2 text-xs cursor-pointer",a),children:(0,t.jsx)("span",{children:r})});return s?(0,t.jsxs)(e_.Tooltip,{children:[(0,t.jsx)(e_.TooltipTrigger,{asChild:!0,children:i}),(0,t.jsx)(e_.TooltipContent,{side:"right",children:(0,t.jsx)("p",{className:"text-xs max-w-xs",children:s})})]}):i};var ew=e.i(974900);let eN=["anon","authenticated","service_role"],eS=["postgres","authenticator","supabase_auth_admin","supabase_storage_admin","supabase_etl_admin","supabase_realtime_admin","supabase_replication_admin","supabase_read_only_user","dashboard_user","supabase_admin"],eC={anon:{displayName:"Anonymous (Logged Out)"},authenticated:{displayName:"Authenticated (Logged In)"},service_role:{displayName:"Service Role"},postgres:{displayName:"Postgres"},authenticator:{displayName:"Authenticator"},supabase_auth_admin:{displayName:"Auth Admin"},supabase_storage_admin:{displayName:"Storage Admin"},supabase_etl_admin:{displayName:"ETL Admin"},supabase_realtime_admin:{displayName:"Realtime Admin"},supabase_replication_admin:{displayName:"Replication Admin"},supabase_read_only_user:{displayName:"Read-Only User"},dashboard_user:{displayName:"Dashboard User"},supabase_admin:{displayName:"Supabase Admin"}},eT=({activeOptions:e,onSaveFilters:r,className:s})=>{let{roles:a,roleGroups:i,isLoadingRoles:n}=(()=>{let{data:e}=(0,R.useSelectedProjectQuery)(),{data:t,isPending:r}=(0,ew.useDatabaseRolesQuery)({projectRef:e?.ref,connectionString:e?.connectionString}),s=(0,l.useMemo)(()=>new Set(eN),[]),a=(0,l.useMemo)(()=>new Set(eS),[]),i=(0,l.useMemo)(()=>(t??[]).sort((e,t)=>e.name.localeCompare(t.name)).map(e=>({...e,displayName:e.name in eC?eC[e.name].displayName:e.name})),[t]),n=(0,l.useMemo)(()=>[{name:"User Access",options:i.filter(e=>s.has(e.name)).map(e=>e.name)},{name:"System and Services",options:i.filter(e=>a.has(e.name)).map(e=>e.name)},{name:"Custom",options:i.filter(e=>!s.has(e.name)&&!a.has(e.name)).map(e=>e.name)}],[s,i,a]);return{roles:i,roleGroups:n,isLoadingRoles:r}})();return(0,t.jsx)(ej.FilterPopover,{name:"Roles",options:a,labelKey:"displayName",valueKey:"name",activeOptions:n?[]:e,onSaveFilters:r,className:s||"w-60",groups:i,renderLabel:(e,r)=>(0,t.jsx)(ev,{htmlFor:r,label:e.displayName,description:e.description})})},eR=({sort:e,onClearSort:r})=>(0,t.jsxs)("div",{className:"text-xs border rounded-md px-1.5 md:px-2.5 py-1 h-[26px] flex items-center gap-x-2",children:[(0,t.jsxs)("p",{className:"md:inline-flex gap-x-1 hidden truncate",children:["Sort: ",e.column," ",(0,t.jsx)("span",{className:"text-foreground-lighter",children:e.order})]}),(0,t.jsxs)(e_.Tooltip,{children:[(0,t.jsx)(e_.TooltipTrigger,{onClick:r,children:(0,t.jsx)(eh.X,{size:14,className:"text-foreground-light hover:text-foreground"})}),(0,t.jsx)(e_.TooltipContent,{side:"bottom",children:"Clear sort"})]})]});var eA=e.i(593484);let eq=({actions:e,showRolesFilter:s=!1})=>{let{sort:n,clearSort:o}=i(),{isIndexAdvisorEnabled:c}=(0,a.useIndexAdvisorStatus)(),[{search:d,roles:u,callsFilter:m,totalTimeFilter:p,indexAdvisor:x},h]=(0,r.useQueryStates)({search:r.parseAsString.withDefault(""),roles:(0,r.parseAsArrayOf)(r.parseAsString).withDefault([]),callsFilter:(0,r.parseAsJson)(e=>null==e?null:e),totalTimeFilter:(0,r.parseAsJson)(e=>null==e?null:e),indexAdvisor:r.parseAsString.withDefault("false")}),f=m??null,g=p??null,[_,y]=(0,l.useState)({roles:u}),[b,j]=(0,l.useState)(d),v=(0,eA.useDebouncedValue)(b,300);return(0,l.useEffect)(()=>{h({search:v||""})},[v]),(0,t.jsxs)("div",{className:"px-4 py-1.5 bg-surface-200 border-t -mt-px flex justify-between items-center overflow-x-auto overflow-y-hidden w-full flex-shrink-0",children:[(0,t.jsx)("div",{className:"flex items-center gap-x-4",children:(0,t.jsxs)("div",{className:"flex items-center gap-x-2",children:[(0,t.jsx)(eg,{value:b,onChange:j}),f?(0,t.jsx)(ey,{label:"Calls",value:(f?`${f.operator} ${f.value}`:null)||"",onClear:e=>{e.stopPropagation(),h({callsFilter:null})}}):(0,t.jsx)(ep.ReportsNumericFilter,{label:"Calls",value:f,onChange:e=>h({callsFilter:e}),operators:["=",">=","<=",">","<","!="],defaultOperator:">=",placeholder:"e.g. 100",min:0,className:"w-auto"}),g?(0,t.jsx)(ey,{label:"Total Time",value:(g?`${g.operator} ${g.value}`:null)||"",onClear:e=>{e.stopPropagation(),h({totalTimeFilter:null})}}):(0,t.jsx)(ep.ReportsNumericFilter,{label:"Total Time",value:g,onChange:e=>h({totalTimeFilter:e}),operators:["=",">=","<=",">","<","!="],defaultOperator:">",placeholder:"e.g. 1000",min:0,className:"w-auto"}),s&&(_.roles&&_.roles.length>0?(0,t.jsx)(ey,{label:"Roles",value:_.roles.join(", "),onClear:e=>{e.stopPropagation(),y({roles:[]}),h({roles:[]})}}):(0,t.jsx)(eT,{activeOptions:_.roles,onSaveFilters:e=>{y({..._,roles:e}),h({roles:e})}})),c&&(0,t.jsx)(eb,{isActive:"true"===x,onToggle:()=>{h({indexAdvisor:"true"===x?"false":"true"})}}),n&&(0,t.jsx)(eR,{sort:n,onClearSort:o})]})}),(0,t.jsx)("div",{className:"flex gap-2 items-center pl-2",children:e})]})};var eE=e.i(924529),eF=e.i(106579),ek=e.i(189329);K.default.extend(en.default);let eP=({dateRange:e,onDateRangeChange:r})=>{let{ref:a}=(0,s.useParams)(),{data:i}=(0,R.useSelectedProjectQuery)(),n=(0,ek.useDatabaseSelectorStateSnapshot)(),[o,c]=(0,l.useState)(null),d=(0,l.useMemo)(()=>{if(e)return{iso_timestamp_start:e.period_start.date,iso_timestamp_end:e.period_end.date};let t=K.default.utc();return{iso_timestamp_start:t.subtract(24,"hours").toISOString(),iso_timestamp_end:t.toISOString()}},[e]),u=(0,l.useMemo)(()=>(0,W.getPgStatMonitorLogsQuery)(d.iso_timestamp_start,d.iso_timestamp_end),[d]),m=(0,eE.default)(a,{sql:u,iso_timestamp_start:d.iso_timestamp_start,iso_timestamp_end:d.iso_timestamp_end}),{logData:p,isLoading:x,error:h}=m,f=(0,l.useMemo)(()=>{var e;return 0===(e=p||[]).length?[]:e.map(e=>({...e,parsedEventMessage:(e=>{try{let t=e.replace("[pg_stat_monitor] ","");return t=t.replace(/""/g,'","'),JSON.parse(t)}catch(e){return null}})(e.event_message)})).filter(e=>null!==e.parsedEventMessage).filter(e=>e.parsedEventMessage?.event==="bucket_query").map(e=>e.parsedEventMessage)},[p]),g=(0,l.useMemo)(()=>f&&0!==f.length?f.map(e=>{let t=[e.bucket_start_time,e.bucket,e.timestamp,e.ts],r=null;for(let e of t)if(e){let t=new Date(e).getTime();if(!isNaN(t)&&t>0&&t>9466848e5){r=t;break}}if(!r)return null;let s=e.resp_calls&&Array.isArray(e.resp_calls)?eo(e.resp_calls):{p50:0,p95:0};return{period_start:r,timestamp:t.find(e=>e)||"",query_latency:parseFloat(String(e.mean_time??e.mean_exec_time??e.mean_query_time??0)),mean_time:parseFloat(String(e.mean_time??e.mean_exec_time??e.mean_query_time??0)),min_time:parseFloat(String(e.min_time??e.min_exec_time??e.min_query_time??0)),max_time:parseFloat(String(e.max_time??e.max_exec_time??e.max_query_time??0)),stddev_time:parseFloat(String(e.stddev_time??e.stddev_exec_time??e.stddev_query_time??0)),p50_time:s.p50,p95_time:s.p95,rows_read:parseInt(String(e.rows??0),10),calls:parseInt(String(e.calls??0),10),cache_hits:parseFloat(String(e.shared_blks_hit??0)),cache_misses:parseFloat(String(e.shared_blks_read??0))}}).filter(e=>null!==e).sort((e,t)=>e.period_start-t.period_start):[],[f]),_=(0,l.useMemo)(()=>(e=>{if(!e||0===e.length)return[];let t=new Map;e.forEach(e=>{let r=(e.query||"").replace(/\s+/g," ").trim();r&&(t.has(r)||t.set(r,[]),t.get(r).push(e))});let r=[],s=0;return Array.from(t.entries()).map(([e,t])=>{let r=t.length,a=0,i=0,l=0,n=0,o=t[0].username,c=1/0,d=-1/0,u=0;t.forEach(e=>{let t=parseFloat(String(e.mean_time??e.mean_exec_time??e.mean_query_time??0)),r=parseFloat(String(e.min_time??e.min_exec_time??e.min_query_time??0)),s=parseFloat(String(e.max_time??e.max_exec_time??e.max_query_time??0)),o=parseInt(String(e.calls??0),10),m=parseInt(String(e.rows??0),10),p=parseFloat(String(e.shared_blks_hit??0)),x=parseFloat(String(e.shared_blks_read??0));c=Math.min(c,r),d=Math.max(d,s),a+=o,i+=m,l+=p,n+=x,u+=t*o});let m=a>0?u/a:0,p=c===1/0?0:c,x=d===-1/0?0:d;return s+=u,{query:e,rolname:o,count:r,avgMeanTime:m,minTime:p,maxTime:x,totalCalls:a,totalRowsRead:i,totalTime:u,totalCacheHits:l,totalCacheMisses:n}}).forEach(e=>{let t=e.totalCacheHits+e.totalCacheMisses,a=t>0?e.totalCacheHits/t*100:0,i=s>0?e.totalTime/s*100:0;r.push({query:e.query,rolname:e.rolname,calls:e.totalCalls,mean_time:e.avgMeanTime,min_time:e.minTime,max_time:e.maxTime,total_time:e.totalTime,rows_read:e.totalRowsRead,cache_hit_rate:a,prop_total_time:i,index_advisor_result:null,_total_cache_hits:e.totalCacheHits,_total_cache_misses:e.totalCacheMisses,_count:e.count})}),r.sort((e,t)=>t.total_time-e.total_time)})(f),[f]);return(0,l.useEffect)(()=>{if(h){let e=J(h);ee(h,{projectRef:a,databaseIdentifier:n.selectedDatabaseId,queryPreset:"pg_stat_monitor",queryType:"monitor",postgresVersion:i?.dbVersion,databaseType:n.selectedDatabaseId===a?"primary":"read-replica",sql:u,errorMessage:e||void 0})}},[h,a,n.selectedDatabaseId,i?.dbVersion,u]),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(em,{dateRange:e,onDateRangeChange:r,chartData:g,isLoading:x,error:h,currentSelectedQuery:o,parsedLogs:f}),(0,t.jsx)(eq,{actions:(0,t.jsx)(eF.DownloadResultsButton,{results:_,fileName:`Supabase Query Performance Monitor (${a})`,align:"end"})}),(0,t.jsx)(ei.LoadingLine,{loading:x}),(0,t.jsx)(ea,{aggregatedData:_,isLoading:x,error:h?J(h)||"Failed to load query performance data":null,currentSelectedQuery:o,onCurrentSelectQuery:e=>{c(t=>t===e?null:e)},onRetry:()=>{m.runQuery()}})]})};var eL=e.i(61187),eI=e.i(809934),eD=e.i(592383),eM=e.i(466472),eQ=e.i(124416),e$=e.i(947748),eO=e.i(10429),eB=e.i(714403),ez=e.i(355901),eH=e.i(150671),eU=e.i(940009),eV=e.i(833655),eW=e.i(903248),eY=e.i(494031);let eG=()=>{let{data:e,isLoading:s}=(0,eY.useQueryPerformanceQuery)({preset:"queryMetrics"}),[,a]=(0,r.useQueryStates)({totalTimeFilter:(0,r.parseAsJson)(e=>null==e?null:e)}),i=(0,l.useMemo)(()=>[{title:e?.[0]?.slow_queries===1?"Slow Query":"Slow Queries",value:e?.[0]?.slow_queries||"0",onClick:()=>{a({totalTimeFilter:{operator:">",value:1e3}})}},{title:"Cache Hit Rate",value:e?.[0]?.cache_hit_rate||"0%",tooltip:"Percentage of data read from cache vs disk. Higher is better - it means faster queries and less database load."},{title:"Avg. Rows Per Call",value:e?.[0]?.avg_rows_per_call||"0",tooltip:"Average number of rows returned per query execution. Helps identify queries that return too much or too little data."}],[e,a]);return(0,t.jsx)("section",{className:"px-6 pt-2 pb-4 flex flex-wrap gap-x-6 gap-y-2 w-full",children:i.map((e,r)=>(0,t.jsxs)(l.default.Fragment,{children:[(0,t.jsx)("div",{className:(0,v.cn)("flex items-baseline gap-2 heading-subSection text-foreground-light",{"cursor-pointer hover:text-foreground transition-colors":e.onClick}),onClick:e.onClick,children:s?(0,t.jsx)(eW.Skeleton,{className:"h-5 w-24"}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("span",{className:"text-foreground",children:e.value}),(0,t.jsxs)("span",{className:"flex items-center gap-1",children:[e.title,("Slow Queries"===e.title||"Slow Query"===e.title)&&(0,t.jsxs)(e_.Tooltip,{children:[(0,t.jsx)(e_.TooltipTrigger,{asChild:!0,children:(0,t.jsx)("button",{type:"button","aria-label":"How are slow queries calculated?",className:"inline-flex h-4 w-4 items-center justify-center rounded-full bg-surface-200 text-foreground-lighter transition-colors hover:bg-surface-300 hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-foreground-lighter",onClick:e=>{e.stopPropagation()},children:(0,t.jsx)(eV.Info,{size:12})})}),(0,t.jsx)(e_.TooltipContent,{side:"top",align:"start",className:"max-w-xs text-xs",children:"Slow queries are those with total execution time (execution time + planning time) greater than 1000ms."})]}),e.tooltip&&(0,t.jsxs)(e_.Tooltip,{children:[(0,t.jsx)(e_.TooltipTrigger,{asChild:!0,children:(0,t.jsx)("button",{type:"button","aria-label":`What is ${e.title}?`,className:"inline-flex h-4 w-4 items-center justify-center rounded-full bg-surface-200 text-foreground-lighter transition-colors hover:bg-surface-300 hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-foreground-lighter",onClick:e=>{e.stopPropagation()},children:(0,t.jsx)(eV.Info,{size:12})})}),(0,t.jsx)(e_.TooltipContent,{side:"top",align:"start",className:"max-w-xs text-xs",children:e.tooltip})]})]})]})}),r<i.length-1&&(0,t.jsx)("span",{className:"text-foreground-muted",children:"/"})]},r))})},eK=({queryHitRate:e,queryPerformanceQuery:a,queryMetrics:i})=>{let{ref:n}=(0,s.useParams)(),{data:o}=(0,R.useSelectedProjectQuery)(),c=(0,ek.useDatabaseSelectorStateSnapshot)(),{data:d,isLoading:u,isRefetching:m,error:h}=a,f=c.selectedDatabaseId===n,g=(0,eU.formatDatabaseID)(c.selectedDatabaseId??""),_="error"in e?e.error:null,y="error"in i?i.error:null,b=h||null,[j,w]=(0,l.useState)(!1),[N,T]=(0,eQ.useLocalStorageQuery)(e$.LOCAL_STORAGE_KEYS.QUERY_PERF_SHOW_BOTTOM_SECTION,!0),[{indexAdvisor:A}]=(0,r.useQueryStates)({indexAdvisor:r.parseAsString.withDefault("false")}),q=()=>{a.runQuery(),e.runQuery(),i.runQuery()},E=(0,l.useMemo)(()=>((e,t=!1)=>{if(!e||0===e.length)return[];let r=e.reduce((e,t)=>e+(t.total_time||0),0);return e.map(e=>{let t=e.index_advisor_result?(0,C.filterProtectedSchemaIndexAdvisorResult)(e.index_advisor_result):null;return{query:e.query,rolname:e.rolname||void 0,calls:e.calls||0,mean_time:e.mean_time||0,min_time:e.min_time||0,max_time:e.max_time||0,total_time:e.total_time||0,rows_read:e.rows_read||0,cache_hit_rate:e.cache_hit_rate||0,prop_total_time:r>0?e.total_time/r*100:0,index_advisor_result:t}}).filter(e=>{if(t){let t=null!==e.index_advisor_result;if((0,C.queryInvolvesProtectedSchemas)(e.query)&&!t)return!1}return!0})})(d||[],"true"===A),[d,A]),{data:F}=(0,eH.useReadReplicasQuery)({projectRef:n});(0,l.useEffect)(()=>{c.setSelectedDatabaseId(n)},[n]),(0,l.useEffect)(()=>{if(b){let e=J(b);ee(b,{projectRef:n,databaseIdentifier:c.selectedDatabaseId,queryPreset:"unified",queryType:"mainQuery",postgresVersion:o?.dbVersion,databaseType:f?"primary":"read-replica",sql:a.resolvedSql,errorMessage:e||void 0})}},[b,n,c.selectedDatabaseId,o?.dbVersion,f,a.resolvedSql]),(0,l.useEffect)(()=>{if(_){let e=J(_);ee(_,{projectRef:n,databaseIdentifier:c.selectedDatabaseId,queryPreset:"queryHitRate",queryType:"hitRate",postgresVersion:o?.dbVersion,databaseType:f?"primary":"read-replica",errorMessage:e||void 0})}},[_,n,c.selectedDatabaseId,o?.dbVersion,f]),(0,l.useEffect)(()=>{if(y){let e=J(y);ee(y,{projectRef:n,databaseIdentifier:c.selectedDatabaseId,queryPreset:"queryMetrics",queryType:"metrics",postgresVersion:o?.dbVersion,databaseType:f?"primary":"read-replica",errorMessage:e||void 0})}},[y,n,c.selectedDatabaseId,o?.dbVersion,f]);let k=b||_||y,P=b?J(b)||"Failed to load query performance data":_?J(_)||"Failed to load cache hit rate data":y?J(y)||"Failed to load query metrics":null;return(0,t.jsxs)(t.Fragment,{children:[k&&(0,t.jsx)("div",{className:"px-6 pt-4",children:(0,t.jsx)(S.Admonition,{type:"destructive",title:"Error loading query performance data",description:P||"An error occurred while loading query performance data. Please try refreshing the page."})}),(0,t.jsx)(eG,{}),(0,t.jsx)(eq,{showRolesFilter:!0,actions:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(p.ButtonTooltip,{type:"default",size:"tiny",icon:(0,t.jsx)(eL.RefreshCw,{}),onClick:q,tooltip:{content:{side:"top",text:"Refresh"}},className:"w-[26px]"}),(0,t.jsx)(p.ButtonTooltip,{type:"default",size:"tiny",icon:(0,t.jsx)(eI.RotateCcw,{}),onClick:()=>w(!0),tooltip:{content:{side:"top",text:"Reset report"}},className:"w-[26px]"}),(0,t.jsx)(eF.DownloadResultsButton,{results:E,fileName:`Supabase Query Performance Statements (${n})`,align:"end"})]})}),(0,t.jsx)(ei.LoadingLine,{loading:u||m}),(0,t.jsx)(ea,{aggregatedData:E,isLoading:u,error:b?J(b)||"Failed to load query performance data":null,onRetry:q}),(0,t.jsxs)("div",{className:(0,v.cn)("px-6 py-6 flex gap-x-4 border-t relative",{hidden:!1===N}),children:[(0,t.jsx)(x.Button,{className:"absolute top-1.5 right-3 px-1.5",type:"text",size:"tiny",onClick:()=>T(!1),children:(0,t.jsx)(eh.X,{size:"14"})}),(0,t.jsxs)("div",{className:"w-[33%] flex flex-col gap-y-1 text-sm",children:[(0,t.jsx)("p",{children:"Reset report"}),(0,t.jsx)("p",{className:"text-xs text-foreground-light",children:"Consider resetting the analysis after optimizing any queries"}),(0,t.jsx)(x.Button,{type:"default",className:"!mt-3 w-min",onClick:()=>w(!0),children:"Reset report"})]}),(0,t.jsxs)("div",{className:"w-[33%] flex flex-col gap-y-1 text-sm",children:[(0,t.jsx)("p",{children:"How is this report generated?"}),(0,t.jsx)(eD.Markdown,{className:"text-xs",content:`This report uses the pg_stat_statements table, and pg_stat_statements extension. [Learn more here](${eO.DOCS_URL}/guides/platform/performance#examining-query-performance).`})]}),(0,t.jsxs)("div",{className:"w-[33%] flex flex-col gap-y-1 text-sm",children:[(0,t.jsx)("p",{children:"Inspect your database for potential issues"}),(0,t.jsx)(eD.Markdown,{className:"text-xs",content:`The Supabase CLI comes with a range of tools to help inspect your Postgres instances for
            potential issues. [Learn more here](${eO.DOCS_URL}/guides/database/inspect).`})]})]}),(0,t.jsx)(eM.default,{visible:j,size:"medium",variant:"destructive",title:"Reset query performance analysis",confirmLabel:"Reset report",confirmLabelLoading:"Resetting report",onCancel:()=>w(!1),onConfirm:async()=>{let e=F?.find(e=>e.identifier===c.selectedDatabaseId)?.connectionString;if(eO.IS_PLATFORM&&!e)return ez.toast.error("Unable to run query: Connection string is missing");try{await (0,eB.executeSql)({projectRef:o?.ref,connectionString:e,sql:"SELECT pg_stat_statements_reset();"}),q(),w(!1)}catch(e){ez.toast.error(`Failed to reset analysis: ${e.message}`)}},children:(0,t.jsxs)("p",{className:"text-foreground-light text-sm",children:["This will reset the pg_stat_statements table in the extensions schema on your"," ",(0,t.jsx)("span",{className:"text-foreground",children:f?"primary database":`read replica (ID: ${g})`}),", which is used to calculate query performance. This data will repopulate immediately after."]})})]})},eX=({queryHitRate:e,queryPerformanceQuery:r,queryMetrics:a,isPgStatMonitorEnabled:i,dateRange:n,onDateRangeChange:o})=>{let{ref:c}=(0,s.useParams)(),d=(0,ek.useDatabaseSelectorStateSnapshot)();return((0,l.useEffect)(()=>{d.setSelectedDatabaseId(c)},[c]),i)?(0,t.jsx)(eP,{dateRange:n,onDateRangeChange:o}):(0,t.jsx)(eK,{queryHitRate:e,queryPerformanceQuery:r,queryMetrics:a})};var eJ=e.i(820308),eZ=e.i(775159),e0=e.i(554344),e1=e.i(748356),e2=e.i(448710),e4=e.i(212846),e5=e.i(282492),e3=e.i(513826),e8=e.i(156442);let e9=()=>{let{ref:e}=(0,s.useParams)(),{data:l,isLoading:n}=(0,R.useSelectedProjectQuery)(),{isIndexAdvisorEnabled:o}=(0,a.useIndexAdvisorStatus)(),{sort:c}=i(),{selectedDateRange:d,datePickerValue:u,datePickerHelpers:m,updateDateRange:p,handleDatePickerChange:x}=(0,e8.useReportDateRange)(eJ.REPORT_DATERANGE_HELPER_LABELS.LAST_60_MINUTES),[{search:h,roles:f,minCalls:g,totalTimeFilter:_,indexAdvisor:y}]=(0,r.useQueryStates)({sort:r.parseAsString,order:r.parseAsString,search:r.parseAsString.withDefault(""),roles:(0,r.parseAsArrayOf)(r.parseAsString).withDefault([]),minCalls:r.parseAsInteger,totalTimeFilter:(0,r.parseAsJson)(e=>null==e?null:e),indexAdvisor:r.parseAsString.withDefault("false")}),b=_??null,j=eJ.PRESET_CONFIG[eZ.Presets.QUERY_PERFORMANCE],v=(0,e0.queriesFactory)(j.queries,e??"default"),w=v.queryHitRate(),N=v.queryMetrics(),C=b&&">"===b.operator||b&&">="===b.operator?b.value:void 0,T=(0,eY.useQueryPerformanceQuery)({searchQuery:h,orderBy:c||void 0,preset:"unified",roles:f,runIndexAdvisor:o,minCalls:g??void 0,minTotalTime:C,filterIndexAdvisor:"true"===y}),A=l?.dbVersion==="17.4.1.076-psml-1";return n||l?(0,t.jsxs)("div",{className:"h-full flex flex-col",children:[(0,t.jsxs)("div",{className:"w-full mb-0 flex lg:items-center justify-between gap-4 py-4 px-6 lg:flex-row flex-col",children:[(0,t.jsx)("h3",{className:"text-foreground text-xl prose",children:"Query Performance"}),(0,t.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,t.jsx)(e3.DocsButton,{href:`${eO.DOCS_URL}/guides/platform/performance#examining-query-performance`}),(0,t.jsx)(e5.DatabaseSelector,{}),A&&(0,t.jsx)(e1.LogsDatePicker,{value:u,helpers:m.filter(e=>e.text===eJ.REPORT_DATERANGE_HELPER_LABELS.LAST_60_MINUTES||e.text===eJ.REPORT_DATERANGE_HELPER_LABELS.LAST_3_HOURS||e.text===eJ.REPORT_DATERANGE_HELPER_LABELS.LAST_24_HOURS),onSubmit:x})]})]}),(0,t.jsx)(eX,{queryHitRate:w,queryPerformanceQuery:T,queryMetrics:N,isPgStatMonitorEnabled:A,dateRange:d,onDateRangeChange:p})]}):(0,t.jsx)("div",{className:"h-full flex flex-col p-6",children:(0,t.jsx)(S.Admonition,{type:"destructive",title:"Project not found",description:"Unable to load project data. Please check your project reference and try again."})})};e9.getLayout=e=>(0,t.jsx)(e2.DefaultLayout,{children:(0,t.jsx)(e4.default,{title:"Query performance",children:e})}),e.s(["default",0,e9],821463)},7786,(e,t,r)=>{let s="/project/[ref]/observability/query-performance";(window.__NEXT_P=window.__NEXT_P||[]).push([s,()=>e.r(821463)]),t.hot&&t.hot.dispose(function(){window.__NEXT_P.push([s])})}]);

//# debugId=8f7182c6-8204-2579-cff9-ebbeb24dd0da
//# sourceMappingURL=e91da99cb6782982.js.map